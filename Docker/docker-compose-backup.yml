version: '3.8'

services:
  # ============================================================================
  # MQTT Protocol Setup (Emotion Recognition)
  
  # MQTT Broker (Mosquitto)
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: fl-mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mqtt-config:/mosquitto/config
    networks:
      - fl-mqtt-network
    command: mosquitto -c /mosquitto/config/mosquitto.conf
  # MQTT FL Server (Emotion Recognition)
  fl-server-mqtt-emotion:
    build:
      context: .
      dockerfile: Server/Dockerfile
    container_name: fl-server-mqtt-emotion
    depends_on:
      - mqtt-broker
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - NUM_CLIENTS=2
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
    command: python -u Server/Emotion_Recognition/FL_Server_MQTT.py
      - ./Server/Emotion_Recognition/results:/app/Server/Emotion_Recognition/results
  # MQTT FL Client 1 (Emotion Recognition)
  fl-client-mqtt-emotion-1:
      dockerfile: Client/Dockerfile
    container_name: fl-client-mqtt-emotion-1
      - fl-server-mqtt-emotion
      - CLIENT_ID=1
    command: python -u Client/Emotion_Recognition/FL_Client_MQTT.py
  # MQTT FL Client 2 (Emotion Recognition)
  fl-client-mqtt-emotion-2:
    container_name: fl-client-mqtt-emotion-2
      - CLIENT_ID=2
  # AMQP Protocol Setup (Emotion Recognition)
  # RabbitMQ Broker
  rabbitmq:
    image: rabbitmq:3-management
    container_name: fl-rabbitmq
      - "5672:5672"
      - "15672:15672"
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - fl-amqp-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  # AMQP FL Server (Emotion Recognition)
  fl-server-amqp-emotion:
    container_name: fl-server-amqp-emotion
      rabbitmq:
        condition: service_healthy
      - AMQP_HOST=rabbitmq
      - AMQP_PORT=5672
    command: python -u Server/Emotion_Recognition/FL_Server_AMQP.py
  # AMQP FL Client 1 (Emotion Recognition)
  fl-client-amqp-emotion-1:
    container_name: fl-client-amqp-emotion-1
      - fl-server-amqp-emotion
    command: python -u Client/Emotion_Recognition/FL_Client_AMQP.py
  # AMQP FL Client 2 (Emotion Recognition)
  fl-client-amqp-emotion-2:
    container_name: fl-client-amqp-emotion-2
  # gRPC Protocol Setup (Emotion Recognition)
  # gRPC FL Server (Emotion Recognition)
  fl-server-grpc-emotion:
    container_name: fl-server-grpc-emotion
      - "50051:50051"
      - GRPC_PORT=50051
    command: python -u Server/Emotion_Recognition/FL_Server_gRPC.py
      - fl-grpc-network
  # gRPC FL Client 1 (Emotion Recognition)
  fl-client-grpc-emotion-1:
    container_name: fl-client-grpc-emotion-1
      - fl-server-grpc-emotion
      - GRPC_HOST=fl-server-grpc-emotion
    command: python -u Client/Emotion_Recognition/FL_Client_gRPC.py
  # gRPC FL Client 2 (Emotion Recognition)
  fl-client-grpc-emotion-2:
    container_name: fl-client-grpc-emotion-2
  # QUIC Protocol Setup (Emotion Recognition)
  # QUIC FL Server (Emotion Recognition)
  fl-server-quic-emotion:
    container_name: fl-server-quic-emotion
      - "4433:4433/udp"
      - QUIC_HOST=0.0.0.0
      - QUIC_PORT=4433
    command: python -u Server/Emotion_Recognition/FL_Server_QUIC.py
      - fl-quic-network
      - ./certs:/app/certs
  # QUIC FL Client 1 (Emotion Recognition)
  fl-client-quic-emotion-1:
    container_name: fl-client-quic-emotion-1
      - fl-server-quic-emotion
      - QUIC_HOST=fl-server-quic-emotion
    command: python -u Client/Emotion_Recognition/FL_Client_QUIC.py
  # QUIC FL Client 2 (Emotion Recognition)
  fl-client-quic-emotion-2:
    container_name: fl-client-quic-emotion-2
  # DDS Protocol Setup (Emotion Recognition)
  # DDS FL Server (Emotion Recognition)
  fl-server-dds-emotion:
    container_name: fl-server-dds-emotion
      - DDS_DOMAIN_ID=0
    command: python -u Server/Emotion_Recognition/FL_Server_DDS.py
      - fl-dds-network
  # DDS FL Client 1 (Emotion Recognition)
  fl-client-dds-emotion-1:
    container_name: fl-client-dds-emotion-1
      - fl-server-dds-emotion
    command: python -u Client/Emotion_Recognition/FL_Client_DDS.py
  # DDS FL Client 2 (Emotion Recognition)
  fl-client-dds-emotion-2:
    container_name: fl-client-dds-emotion-2
networks:
  fl-mqtt-network:
    driver: bridge
  fl-amqp-network:
  fl-grpc-network:
  fl-quic-network:
  fl-dds-network:
volumes:
  mqtt-data:
  rabbitmq-data:
