services:
  # ============================================================================
  # BROKERS - Required for MQTT and AMQP protocols
  # ============================================================================
  
  mqtt-broker-unified:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker-unified
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mqtt-config:/mosquitto/config
    networks:
      - fl-network
    command: mosquitto -c /mosquitto/config/mosquitto.conf
  
  amqp-broker-unified:
    image: rabbitmq:3-management
    container_name: amqp-broker-unified
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks:
      - fl-network
  
  # ============================================================================
  # UNIFIED FL SERVER - Handles all 5 protocols simultaneously
  # ============================================================================
  
  fl-server-unified-mentalstate:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-unified-mentalstate
    environment:
      - NODE_TYPE=server
      - NUM_CLIENTS=2
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - MQTT_BROKER=mqtt-broker-unified
      - AMQP_BROKER=amqp-broker-unified
      - GRPC_PORT=50051
      - CONVERGENCE_THRESHOLD=0.001
      - CONVERGENCE_PATIENCE=2
      - MIN_ROUNDS=3
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-ptq}
    volumes:
      - ../Server/MentalState_Recognition:/app/Server/MentalState_Recognition
      - ../experiment_results:/app/results
      - ../shared_data:/shared_data
    networks:
      - fl-network
    depends_on:
      - mqtt-broker-unified
      - amqp-broker-unified
    command: python3 Server/MentalState_Recognition/FL_Server_Unified.py
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  # ============================================================================
  # UNIFIED FL CLIENTS - Use RL to select best protocol dynamically
  # ============================================================================
  
  fl-client-unified-mentalstate-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-unified-mentalstate-1
    environment:
      - NODE_TYPE=client
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - USE_RL_SELECTION=true
      - DEFAULT_PROTOCOL=mqtt
      - MQTT_BROKER=mqtt-broker-unified
      - AMQP_BROKER=amqp-broker-unified
      - GRPC_SERVER=fl-server-unified-mentalstate
      - GRPC_PORT=50051
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-ptq}
    volumes:
      - ../Client/MentalState_Recognition:/app/Client/MentalState_Recognition
      - ../experiment_results:/app/results
      - ../shared_data:/shared_data
    networks:
      - fl-network
    depends_on:
      - fl-server-unified-mentalstate
      - mqtt-broker-unified
      - amqp-broker-unified
    command: python3 Client/MentalState_Recognition/FL_Client_Unified.py
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  fl-client-unified-mentalstate-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-unified-mentalstate-2
    environment:
      - NODE_TYPE=client
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - USE_RL_SELECTION=true
      - DEFAULT_PROTOCOL=mqtt
      - MQTT_BROKER=mqtt-broker-unified
      - AMQP_BROKER=amqp-broker-unified
      - GRPC_SERVER=fl-server-unified-mentalstate
      - GRPC_PORT=50051
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-ptq}
    volumes:
      - ../Client/MentalState_Recognition:/app/Client/MentalState_Recognition
      - ../experiment_results:/app/results
      - ../shared_data:/shared_data
    networks:
      - fl-network
    depends_on:
      - fl-server-unified-mentalstate
      - mqtt-broker-unified
      - amqp-broker-unified
    command: python3 Client/MentalState_Recognition/FL_Client_Unified.py
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

networks:
  fl-network:
    driver: bridge
