version: '3.8'

# ==============================================================================
# Traffic Generator Containers for Network Congestion Testing
# These containers generate background traffic to simulate network congestion
# Can be deployed alongside FL experiments to test protocol performance under load
services:
  # ============================================================================
  # HTTP Traffic Generators (Simulates web traffic)
  
  http-traffic-gen-1:
    image: alpine:latest
    container_name: http-traffic-gen-1
    cap_add:
      - NET_ADMIN
    networks:
      - fl-mqtt-network-temp
      - fl-amqp-network-temp
      - fl-grpc-network-temp
      - fl-quic-network-temp
      - fl-dds-network-temp
    command: >
      sh -c "
      apk add --no-cache curl &&
      echo 'Starting HTTP traffic generator...' &&
      while true; do
        # Generate random HTTP requests
        curl -s -o /dev/null http://fl-server-mqtt-temp:5000 2>/dev/null || true;
        curl -s -o /dev/null http://fl-server-amqp-temp:5000 2>/dev/null || true;
        curl -s -o /dev/null http://fl-server-grpc-temp:50051 2>/dev/null || true;
        sleep 0.5;
      done
      "
    restart: unless-stopped
  http-traffic-gen-2:
    container_name: http-traffic-gen-2
        curl -s -o /dev/null http://mqtt-broker-temp:1883 2>/dev/null || true;
        curl -s -o /dev/null http://rabbitmq-temp:5672 2>/dev/null || true;
        sleep 1;
  # Network Bandwidth Hog (Simulates large file transfers)
  bandwidth-hog:
    container_name: bandwidth-hog
      apk add --no-cache iperf3 &&
      echo 'Starting bandwidth hog...' &&
        # Generate UDP traffic to simulate bulk data transfer
        iperf3 -c fl-server-mqtt-temp -u -b 20M -t 10 2>/dev/null || true;
        iperf3 -c fl-server-amqp-temp -u -b 20M -t 10 2>/dev/null || true;
        sleep 5;
  # Packet Spammer (Simulates chatty protocols)
  packet-spammer:
    container_name: packet-spammer
      apk add --no-cache hping3 2>/dev/null || apk add --no-cache --repository=http://dl-cdn.alpinelinux.org/alpine/edge/testing hping3 &&
      echo 'Starting packet spammer...' &&
        # Send small packets rapidly to create congestion
        ping -i 0.1 -s 64 fl-server-mqtt-temp -c 100 2>/dev/null || true;
        ping -i 0.1 -s 64 fl-server-amqp-temp -c 100 2>/dev/null || true;
        sleep 2;
  # Connection Flood (Simulates many concurrent connections)
  connection-flooder:
    image: python:3.9-alpine
    container_name: connection-flooder
      pip install --no-cache-dir paho-mqtt pika >/dev/null 2>&1 &&
      python -c '
import time
import socket
import threading
from datetime import datetime
def flood_connections(host, port, num_conns=10):
    \"\"\"Create multiple connections to a host\"\"\"
    while True:
        try:
            threads = []
            for i in range(num_conns):
                def connect():
                    try:
                        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                        s.settimeout(2)
                        s.connect((host, port))
                        s.sendall(b\"GET / HTTP/1.1\\r\\nHost: test\\r\\n\\r\\n\")
                        s.recv(1024)
                        s.close()
                    except:
                        pass
                t = threading.Thread(target=connect)
                threads.append(t)
                t.start()
            for t in threads:
                t.join(timeout=3)
            time.sleep(0.5)
        except:
            time.sleep(1)
print(f\"[{datetime.now()}] Starting connection flooder...\")
# Flood multiple targets
targets = [
    (\"mqtt-broker-temp\", 1883),
    (\"rabbitmq-temp\", 5672),
    (\"fl-server-grpc-temp\", 50051),
]
threads = []
for host, port in targets:
    t = threading.Thread(target=flood_connections, args=(host, port, 5))
    t.daemon = True
    t.start()
    threads.append(t)
# Keep running
while True:
    time.sleep(60)
    print(f\"[{datetime.now()}] Connection flooder still running...\")
      '
# Networks - Connect to all FL protocol networks
networks:
  fl-mqtt-network-temp:
    external: true
  fl-amqp-network-temp:
  fl-grpc-network-temp:
  fl-quic-network-temp:
  fl-dds-network-temp:
