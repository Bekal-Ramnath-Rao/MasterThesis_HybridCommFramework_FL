# Docker Compose for Emotion Recognition with GPU Support (Device-Isolated)
# This version isolates GPU devices to prevent memory contention between clients
# Client 1 uses GPU 0, Client 2 uses GPU 1, Server uses both but with memory limits
# Requires: 2+ NVIDIA GPUs with NVIDIA Container Toolkit
# Note: Uses Docker Compose V2 syntax (no version: field)

services:
  mqtt-broker:
    image: eclipse-mosquitto:latest
    ports:
      - "31883:1883"
      - "39001:9001"
    volumes:
      - ../mqtt-config/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - temperature_network
    container_name: mqtt-broker-temperature

  # ============================================================================
  # MQTT Protocol Services
  # ============================================================================
  
  fl-server-mqtt-temperature:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    environment:
      - PROTOCOL=MQTT
      - USE_CASE=temperature
      - MQTT_BROKER=mqtt-broker:1883
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - CUDA_VISIBLE_DEVICES=0,1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.4
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - mqtt-broker
    networks:
      - temperature_network
    container_name: fl-server-mqtt-temperature
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-mqtt-temperature.pcap & python -u Server/Temperature_Regulation/FL_Server_MQTT.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0', '1']

  fl-client-mqtt-temperature-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - PROTOCOL=MQTT
      - USE_CASE=temperature
      - MQTT_BROKER=mqtt-broker:1883
      - CUDA_VISIBLE_DEVICES=0
      - GPU_DEVICE_ID=0
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - mqtt-broker
      - fl-server-mqtt-temperature
    networks:
      - temperature_network
    container_name: fl-client-mqtt-temperature-1
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-mqtt-temperature-1.pcap & python -u Client/Temperature_Regulation/FL_Client_MQTT.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0']

  fl-client-mqtt-temperature-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - PROTOCOL=MQTT
      - USE_CASE=temperature
      - MQTT_BROKER=mqtt-broker:1883
      - CUDA_VISIBLE_DEVICES=1
      - GPU_DEVICE_ID=1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - mqtt-broker
      - fl-server-mqtt-temperature
    networks:
      - temperature_network
    container_name: fl-client-mqtt-temperature-2
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-mqtt-temperature-2.pcap & python -u Client/Temperature_Regulation/FL_Client_MQTT.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['1']

  # ============================================================================
  # AMQP Protocol Services
  # ============================================================================
  
  amqp-broker:
    image: rabbitmq:3.12-management
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    ports:
      - "35672:5672"
      - "35671:15672"
    networks:
      - temperature_network
    container_name: amqp-broker-temperature

  fl-server-amqp-temperature:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    environment:
      - PROTOCOL=AMQP
      - USE_CASE=temperature
      - AMQP_BROKER=amqp://guest:guest@amqp-broker:5672/
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - CUDA_VISIBLE_DEVICES=0,1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.4
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - amqp-broker
    networks:
      - temperature_network
    container_name: fl-server-amqp-temperature
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-amqp-temperature.pcap & python -u Server/Temperature_Regulation/FL_Server_AMQP.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0', '1']

  fl-client-amqp-temperature-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - PROTOCOL=AMQP
      - USE_CASE=temperature
      - AMQP_BROKER=amqp://guest:guest@amqp-broker:5672/
      - CUDA_VISIBLE_DEVICES=0
      - GPU_DEVICE_ID=0
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - amqp-broker
      - fl-server-amqp-temperature
    networks:
      - temperature_network
    container_name: fl-client-amqp-temperature-1
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-amqp-temperature-1.pcap & python -u Client/Temperature_Regulation/FL_Client_AMQP.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0']

  fl-client-amqp-temperature-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - PROTOCOL=AMQP
      - USE_CASE=temperature
      - AMQP_BROKER=amqp://guest:guest@amqp-broker:5672/
      - CUDA_VISIBLE_DEVICES=1
      - GPU_DEVICE_ID=1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - amqp-broker
      - fl-server-amqp-temperature
    networks:
      - temperature_network
    container_name: fl-client-amqp-temperature-2
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-amqp-temperature-2.pcap & python -u Client/Temperature_Regulation/FL_Client_AMQP.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['1']

  # ============================================================================
  # gRPC Protocol Services
  # ============================================================================
  
  fl-server-grpc-temperature:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    environment:
      - PROTOCOL=gRPC
      - USE_CASE=temperature
      - GRPC_PORT=50051
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - CUDA_VISIBLE_DEVICES=0,1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.4
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    ports:
      - "50051:50051"
    networks:
      - temperature_network
    container_name: fl-server-grpc-temperature
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-grpc-temperature.pcap & python -u Server/Temperature_Regulation/FL_Server_gRPC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0', '1']

  fl-client-grpc-temperature-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - PROTOCOL=gRPC
      - USE_CASE=temperature
      - GRPC_SERVER=fl-server-grpc-temperature:50051
      - CUDA_VISIBLE_DEVICES=0
      - GPU_DEVICE_ID=0
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - fl-server-grpc-temperature
    networks:
      - temperature_network
    container_name: fl-client-grpc-temperature-1
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-grpc-temperature-1.pcap & python -u Client/Temperature_Regulation/FL_Client_gRPC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0']

  fl-client-grpc-temperature-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - PROTOCOL=gRPC
      - USE_CASE=temperature
      - GRPC_SERVER=fl-server-grpc-temperature:50051
      - CUDA_VISIBLE_DEVICES=1
      - GPU_DEVICE_ID=1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - fl-server-grpc-temperature
    networks:
      - temperature_network
    container_name: fl-client-grpc-temperature-2
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-grpc-temperature-2.pcap & python -u Client/Temperature_Regulation/FL_Client_gRPC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['1']

  # ============================================================================
  # QUIC Protocol Services
  # ============================================================================
  
  fl-server-quic-temperature:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    environment:
      - PROTOCOL=QUIC
      - USE_CASE=temperature
      - QUIC_PORT=4433
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - CUDA_VISIBLE_DEVICES=0,1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.4
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    ports:
      - "4433:4433/udp"
    networks:
      - temperature_network
    container_name: fl-server-quic-temperature
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-quic-temperature.pcap & python -u Server/Temperature_Regulation/FL_Server_QUIC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0', '1']

  fl-client-quic-temperature-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - PROTOCOL=QUIC
      - USE_CASE=temperature
      - QUIC_SERVER=fl-server-quic-temperature:4433
      - CUDA_VISIBLE_DEVICES=0
      - GPU_DEVICE_ID=0
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - fl-server-quic-temperature
    networks:
      - temperature_network
    container_name: fl-client-quic-temperature-1
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-quic-temperature-1.pcap & python -u Client/Temperature_Regulation/FL_Client_QUIC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0']

  fl-client-quic-temperature-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - PROTOCOL=QUIC
      - USE_CASE=temperature
      - QUIC_SERVER=fl-server-quic-temperature:4433
      - CUDA_VISIBLE_DEVICES=1
      - GPU_DEVICE_ID=1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - fl-server-quic-temperature
    networks:
      - temperature_network
    container_name: fl-client-quic-temperature-2
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-quic-temperature-2.pcap & python -u Client/Temperature_Regulation/FL_Client_QUIC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['1']

  # ============================================================================
  # HTTP/3 Protocol Services
  # ============================================================================
  
  fl-server-http3-temperature:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    environment:
      - PROTOCOL=HTTP3
      - USE_CASE=temperature
      - HTTP3_HOST=0.0.0.0
      - HTTP3_PORT=4434
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - CUDA_VISIBLE_DEVICES=  # Server runs on CPU only (no GPU needed for aggregation)
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    cap_add:
      - NET_ADMIN
    ports:
      - "4434:4434"
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../certs:/app/certs:ro
      - ../Server/Temperature_Regulation/results:/app/Server/Temperature_Regulation/results
    networks:
      - temperature_network
    container_name: fl-server-http3-temperature
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-http3-temperature.pcap & python -u Server/Temperature_Regulation/FL_Server_HTTP3.py"]
    # Server runs on CPU to avoid competing for GPU memory with clients

  fl-client-http3-temperature-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - PROTOCOL=HTTP3
      - USE_CASE=temperature
      - HTTP3_HOST=fl-server-http3-temperature
      - HTTP3_PORT=4434
      - CUDA_VISIBLE_DEVICES=0
      - GPU_DEVICE_ID=0
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-http3-temperature
    networks:
      - temperature_network
    container_name: fl-client-http3-temperature-1
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-http3-temperature-1.pcap & python -u Client/Temperature_Regulation/FL_Client_HTTP3.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0']

  fl-client-http3-temperature-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - PROTOCOL=HTTP3
      - USE_CASE=temperature
      - HTTP3_HOST=fl-server-http3-temperature
      - HTTP3_PORT=4434
      - CUDA_VISIBLE_DEVICES=1
      - GPU_DEVICE_ID=1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-http3-temperature
    networks:
      - temperature_network
    container_name: fl-client-http3-temperature-2
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-http3-temperature-2.pcap & python -u Client/Temperature_Regulation/FL_Client_HTTP3.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['1']

  # ============================================================================
  # DDS Protocol Services
  # ============================================================================
  
  fl-server-dds-temperature:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    environment:
      - PROTOCOL=DDS
      - USE_CASE=temperature
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - CUDA_VISIBLE_DEVICES=0,1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.4
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    networks:
      - temperature_network
    container_name: fl-server-dds-temperature
    cap_add:
      - NET_ADMIN
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-dds-temperature.pcap & python -u Server/Temperature_Regulation/FL_Server_DDS.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0', '1']

  fl-client-dds-temperature-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - PROTOCOL=DDS
      - USE_CASE=temperature
      - CUDA_VISIBLE_DEVICES=0
      - GPU_DEVICE_ID=0
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - fl-server-dds-temperature
    networks:
      - temperature_network
    container_name: fl-client-dds-temperature-1
    cap_add:
      - NET_ADMIN
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-dds-temperature-1.pcap & python -u Client/Temperature_Regulation/FL_Client_DDS.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['0']

  fl-client-dds-temperature-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    environment:
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - PROTOCOL=DDS
      - USE_CASE=temperature
      - CUDA_VISIBLE_DEVICES=1
      - GPU_DEVICE_ID=1
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - TF_GPU_MEMORY_FRACTION=0.9
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    depends_on:
      - fl-server-dds-temperature
    networks:
      - temperature_network
    container_name: fl-client-dds-temperature-2
    cap_add:
      - NET_ADMIN
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-dds-temperature-2.pcap & python -u Client/Temperature_Regulation/FL_Client_DDS.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
              device_ids: ['1']

networks:
  temperature_network:
    driver: bridge
