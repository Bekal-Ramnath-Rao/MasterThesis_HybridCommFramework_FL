version: '3.8'

services:
  # ============================================================================
  # MQTT Protocol Setup (Emotion Recognition)
  # ============================================================================
  
  # MQTT Broker (Mosquitto)
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: fl-mqtt-broker
    ports:
      - "31883:1883"
      - "39001:9001"
    volumes:
      - ../mqtt-config:/mosquitto/config
    networks:
      - fl-mqtt-network
    command: mosquitto -c /mosquitto/config/mosquitto.conf

  # MQTT FL Server (Emotion Recognition)
  fl-server-mqtt-emotion:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-mqtt-emotion
    cap_add:
      - NET_ADMIN
    depends_on:
      - mqtt-broker
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - NUM_CLIENTS=2
      - NUM_ROUNDS=${NUM_ROUNDS:-1000}
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-mqtt-emotion.pcap & python -u Server/Emotion_Recognition/FL_Server_MQTT.py"]
    networks:
      - fl-mqtt-network
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Server/Emotion_Recognition/results:/app/Server/Emotion_Recognition/results
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # MQTT FL Client 1 (Emotion Recognition)
  fl-client-mqtt-emotion-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-mqtt-emotion-1
    cap_add:
      - NET_ADMIN
    depends_on:
      - mqtt-broker
      - fl-server-mqtt-emotion
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-mqtt-emotion-1.pcap & python -u Client/Emotion_Recognition/FL_Client_MQTT.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
    networks:
      - fl-mqtt-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # MQTT FL Client 2 (Emotion Recognition)
  fl-client-mqtt-emotion-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-mqtt-emotion-2
    cap_add:
      - NET_ADMIN
    depends_on:
      - mqtt-broker
      - fl-server-mqtt-emotion
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-mqtt-emotion-2.pcap & python -u Client/Emotion_Recognition/FL_Client_MQTT.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
    networks:
      - fl-mqtt-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # ============================================================================
  # AMQP Protocol Setup (Emotion Recognition)
  # ============================================================================
  
  # RabbitMQ Broker
  rabbitmq:
    image: rabbitmq:3-management
    container_name: fl-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks:
      - fl-amqp-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # AMQP FL Server (Emotion Recognition)
  fl-server-amqp-emotion:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-amqp-emotion
    cap_add:
      - NET_ADMIN
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - AMQP_HOST=rabbitmq
      - AMQP_PORT=5672
      - NUM_CLIENTS=2
      - NUM_ROUNDS=${NUM_ROUNDS:-1000}
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-amqp-emotion.pcap & python -u Server/Emotion_Recognition/FL_Server_AMQP.py"]
    networks:
      - fl-amqp-network
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Server/Emotion_Recognition/results:/app/Server/Emotion_Recognition/results
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # AMQP FL Client 1 (Emotion Recognition)
  fl-client-amqp-emotion-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-amqp-emotion-1
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-amqp-emotion
    environment:
      - AMQP_HOST=rabbitmq
      - AMQP_PORT=5672
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-amqp-emotion-1.pcap & python -u Client/Emotion_Recognition/FL_Client_AMQP.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
    networks:
      - fl-amqp-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # AMQP FL Client 2 (Emotion Recognition)
  fl-client-amqp-emotion-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-amqp-emotion-2
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-amqp-emotion
    environment:
      - AMQP_HOST=rabbitmq
      - AMQP_PORT=5672
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-amqp-emotion-2.pcap & python -u Client/Emotion_Recognition/FL_Client_AMQP.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
    networks:
      - fl-amqp-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # ============================================================================
  # gRPC Protocol Setup (Emotion Recognition)
  # ============================================================================
  
  # gRPC FL Server (Emotion Recognition)
  fl-server-grpc-emotion:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-grpc-emotion
    cap_add:
      - NET_ADMIN
    ports:
      - "50051:50051"
    environment:
      - GRPC_PORT=50051
      - NUM_CLIENTS=2
      - NUM_ROUNDS=${NUM_ROUNDS:-1000}
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-grpc-emotion.pcap & python -u Server/Emotion_Recognition/FL_Server_gRPC.py"]
    networks:
      - fl-grpc-network
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Server/Emotion_Recognition/results:/app/Server/Emotion_Recognition/results
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # gRPC FL Client 1 (Emotion Recognition)
  fl-client-grpc-emotion-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-grpc-emotion-1
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-grpc-emotion
    environment:
      - GRPC_HOST=fl-server-grpc-emotion
      - GRPC_PORT=50051
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-grpc-emotion-1.pcap & python -u Client/Emotion_Recognition/FL_Client_gRPC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../certs:/app/certs
    networks:
      - fl-grpc-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # gRPC FL Client 2 (Emotion Recognition)
  fl-client-grpc-emotion-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-grpc-emotion-2
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-grpc-emotion
    environment:
      - GRPC_HOST=fl-server-grpc-emotion
      - GRPC_PORT=50051
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-grpc-emotion-2.pcap & python -u Client/Emotion_Recognition/FL_Client_gRPC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../certs:/app/certs
    networks:
      - fl-grpc-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # ============================================================================
  # QUIC Protocol Setup (Emotion Recognition)
  # ============================================================================
  
  # QUIC FL Server (Emotion Recognition)
  fl-server-quic-emotion:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-quic-emotion
    cap_add:
      - NET_ADMIN
    ports:
      - "4433:4433/udp"
    environment:
      - QUIC_HOST=0.0.0.0
      - QUIC_PORT=4433
      - NUM_CLIENTS=2
      - NUM_ROUNDS=${NUM_ROUNDS:-1000}
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-quic-emotion.pcap & python -u Server/Emotion_Recognition/FL_Server_QUIC.py"]
    networks:
      - fl-quic-network
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Server/Emotion_Recognition/results:/app/Server/Emotion_Recognition/results
      - ../certs:/app/certs
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # QUIC FL Client 1 (Emotion Recognition)
  fl-client-quic-emotion-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-quic-emotion-1
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-quic-emotion
    environment:
      - QUIC_HOST=fl-server-quic-emotion
      - QUIC_PORT=4433
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-quic-emotion-1.pcap & python -u Client/Emotion_Recognition/FL_Client_QUIC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../certs:/app/certs
    networks:
      - fl-quic-network
# GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # QUIC FL Client 2 (Emotion Recognition)
  fl-client-quic-emotion-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-quic-emotion-2
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-quic-emotion
    environment:
      - QUIC_HOST=fl-server-quic-emotion
      - QUIC_PORT=4433
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-quic-emotion-2.pcap & python -u Client/Emotion_Recognition/FL_Client_QUIC.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../certs:/app/certs
    networks:
      - fl-quic-network
# GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # ============================================================================
  # HTTP/3 Protocol Setup (Emotion Recognition)
  # ============================================================================
  
  # HTTP/3 FL Server (Emotion Recognition)
  fl-server-http3-emotion:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-http3-emotion
    cap_add:
      - NET_ADMIN
    ports:
      - "4434:4434"
    environment:
      - HTTP3_HOST=0.0.0.0
      - HTTP3_PORT=4434
      - NUM_CLIENTS=2
      - NUM_ROUNDS=${NUM_ROUNDS:-1000}
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-http3-emotion.pcap & python -u Server/Emotion_Recognition/FL_Server_HTTP3.py"]
    networks:
      - fl-http3-network
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Server/Emotion_Recognition/results:/app/Server/Emotion_Recognition/results
      - ../certs:/app/certs:ro
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # HTTP/3 FL Client 1 (Emotion Recognition)
  fl-client-http3-emotion-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-http3-emotion-1
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-http3-emotion
    environment:
      - HTTP3_HOST=fl-server-http3-emotion
      - HTTP3_PORT=4434
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-http3-emotion-1.pcap & python -u Client/Emotion_Recognition/FL_Client_HTTP3.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../certs:/app/certs:ro
    networks:
      - fl-http3-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # HTTP/3 FL Client 2 (Emotion Recognition)
  fl-client-http3-emotion-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-http3-emotion-2
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-http3-emotion
    environment:
      - HTTP3_HOST=fl-server-http3-emotion
      - HTTP3_PORT=4434
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-http3-emotion-2.pcap & python -u Client/Emotion_Recognition/FL_Client_HTTP3.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../certs:/app/certs:ro
    networks:
      - fl-http3-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # ============================================================================
  # DDS Protocol Setup (Emotion Recognition)
  # ============================================================================
  
  # DDS FL Server (Emotion Recognition)
  fl-server-dds-emotion:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-dds-emotion
    cap_add:
      - NET_ADMIN
    environment:
      - DDS_DOMAIN_ID=0
      - NUM_CLIENTS=2
      - NUM_ROUNDS=${NUM_ROUNDS:-1000}
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - CYCLONEDDS_URI=file:///app/cyclonedds-emotion.xml
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-server-dds-emotion.pcap & python -u Server/Emotion_Recognition/FL_Server_DDS.py"]
    networks:
      - fl-dds-network
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Server/Emotion_Recognition/results:/app/Server/Emotion_Recognition/results
      - ../config/cyclonedds-emotion.xml:/app/cyclonedds-emotion.xml:ro
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # DDS FL Client 1 (Emotion Recognition)
  fl-client-dds-emotion-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-dds-emotion-1
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-dds-emotion
    environment:
      - DDS_DOMAIN_ID=0
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - CYCLONEDDS_URI=file:///app/cyclonedds-emotion.xml
      - FL_DIAGNOSTIC_PIPELINE=${FL_DIAGNOSTIC_PIPELINE:-0}
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-dds-emotion-1.pcap & python -u Client/Emotion_Recognition/FL_Client_DDS.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../config/cyclonedds-emotion.xml:/app/cyclonedds-emotion.xml:ro
    networks:
      - fl-dds-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # DDS FL Client 2 (Emotion Recognition)
  fl-client-dds-emotion-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-dds-emotion-2
    cap_add:
      - NET_ADMIN
    depends_on:
      - fl-server-dds-emotion
    environment:
      - DDS_DOMAIN_ID=0
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - CYCLONEDDS_URI=file:///app/cyclonedds-emotion.xml
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-parameter_quantization}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_SYMMETRIC=${QUANTIZATION_SYMMETRIC:-true}
      - QUANTIZATION_PER_CHANNEL=${QUANTIZATION_PER_CHANNEL:-false}
      - FL_EXPERIMENT_SUBDIR=${FL_EXPERIMENT_SUBDIR:-network_captures}
    command: ["sh", "-c", "mkdir -p /app/experiment_results/$FL_EXPERIMENT_SUBDIR && tcpdump -i any -w /app/experiment_results/$FL_EXPERIMENT_SUBDIR/fl-client-dds-emotion-2.pcap & python -u Client/Emotion_Recognition/FL_Client_DDS.py"]
    volumes:
      - ../experiment_results:/app/experiment_results
      - ../Client/Emotion_Recognition/Dataset:/app/Client/Emotion_Recognition/Dataset
      - ../config/cyclonedds-emotion.xml:/app/cyclonedds-emotion.xml:ro
    networks:
      - fl-dds-network
    # GPU reservations moved to overlay file Docker/docker-compose-emotion.gpu.yml

  # ============================================================================
  # Traffic Generator Containers (for Congestion Testing)
  # ============================================================================
  
  http-traffic-gen-1-emotion:
    image: alpine:latest
    container_name: http-traffic-gen-1-emotion
    cap_add:
      - NET_ADMIN
    networks:
      - fl-mqtt-network
      - fl-amqp-network
      - fl-grpc-network
      - fl-quic-network
      - fl-http3-network
      - fl-dds-network
    command: >
      sh -c "
      apk add --no-cache curl &&
      echo 'Starting HTTP traffic generator...' &&
      while true; do
        curl -s -o /dev/null http://fl-server-mqtt-emotion:5000 2>/dev/null || true;
        curl -s -o /dev/null http://fl-server-amqp-emotion:5000 2>/dev/null || true;
        curl -s -o /dev/null http://fl-server-grpc-emotion:50051 2>/dev/null || true;
        sleep 0.5;
      done
      "
    restart: unless-stopped
    profiles:
      - congestion

  http-traffic-gen-2-emotion:
    image: alpine:latest
    container_name: http-traffic-gen-2-emotion
    cap_add:
      - NET_ADMIN
    networks:
      - fl-mqtt-network
      - fl-amqp-network
      - fl-grpc-network
      - fl-quic-network
      - fl-http3-network
      - fl-dds-network
    command: >
      sh -c "
      apk add --no-cache curl &&
      while true; do
        curl -s -o /dev/null http://mqtt-broker:1883 2>/dev/null || true;
        curl -s -o /dev/null http://rabbitmq:5672 2>/dev/null || true;
        sleep 1;
      done
      "
    restart: unless-stopped
    profiles:
      - congestion

  bandwidth-hog-emotion:
    image: alpine:latest
    container_name: bandwidth-hog-emotion
    cap_add:
      - NET_ADMIN
    networks:
      - fl-mqtt-network
      - fl-amqp-network
      - fl-grpc-network
      - fl-quic-network
      - fl-http3-network
      - fl-dds-network
    command: >
      sh -c "
      apk add --no-cache iperf3 &&
      while true; do
        iperf3 -c fl-server-mqtt-emotion -u -b 20M -t 10 2>/dev/null || true;
        iperf3 -c fl-server-amqp-emotion -u -b 20M -t 10 2>/dev/null || true;
        sleep 5;
      done
      "
    restart: unless-stopped
    profiles:
      - congestion

  packet-spammer-emotion:
    image: alpine:latest
    container_name: packet-spammer-emotion
    cap_add:
      - NET_ADMIN
    networks:
      - fl-mqtt-network
      - fl-amqp-network
      - fl-grpc-network
      - fl-quic-network
      - fl-http3-network
      - fl-dds-network
    command: >
      sh -c "
      while true; do
        ping -i 0.1 -s 64 fl-server-mqtt-emotion -c 100 2>/dev/null || true;
        ping -i 0.1 -s 64 fl-server-amqp-emotion -c 100 2>/dev/null || true;
        sleep 2;
      done
      "
    restart: unless-stopped
    profiles:
      - congestion

  connection-flooder-emotion:
    image: python:3.9-alpine
    container_name: connection-flooder-emotion
    cap_add:
      - NET_ADMIN
    networks:
      - fl-mqtt-network
      - fl-amqp-network
      - fl-grpc-network
      - fl-quic-network
      - fl-http3-network
      - fl-dds-network
    command:
      - /bin/sh
      - -c
      - |
        pip install --no-cache-dir paho-mqtt pika >/dev/null 2>&1
        python -c 'import time, socket, threading
        from datetime import datetime
        def flood_connections(host, port, num_conns=10):
            while True:
                try:
                    threads = []
                    for i in range(num_conns):
                        def connect():
                            try:
                                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                                s.settimeout(2)
                                s.connect((host, port))
                                s.sendall(b"GET / HTTP/1.1\r\nHost: test\r\n\r\n")
                                s.recv(1024)
                                s.close()
                            except:
                                pass
                        t = threading.Thread(target=connect)
                        threads.append(t)
                        t.start()
                    for t in threads:
                        t.join(timeout=3)
                    time.sleep(0.5)
                except:
                    time.sleep(1)
        print(f"[{datetime.now()}] Starting connection flooder...")
        targets = [("mqtt-broker", 1883), ("rabbitmq", 5672), ("fl-server-grpc-emotion", 50051)]
        threads = []
        for host, port in targets:
            t = threading.Thread(target=flood_connections, args=(host, port, 5))
            t.daemon = True
            t.start()
            threads.append(t)
        while True:
            time.sleep(60)
            print(f"[{datetime.now()}] Connection flooder still running...")
        '
    restart: unless-stopped
    profiles:
      - congestion

networks:
  fl-mqtt-network:
    driver: bridge
  fl-amqp-network:
    driver: bridge
  fl-grpc-network:
    driver: bridge
  fl-quic-network:
    driver: bridge
  fl-http3-network:
    driver: bridge
  fl-dds-network:
    driver: bridge

volumes:
  mqtt-data:
  rabbitmq-data:



