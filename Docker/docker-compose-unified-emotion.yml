services:
  # ============================================================================
  # BROKERS - Required for MQTT and AMQP protocols
  # ============================================================================
  
  mqtt-broker-unified:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker-unified
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mqtt-config:/mosquitto/config
    networks:
      - fl-network
    command: mosquitto -c /mosquitto/config/mosquitto.conf
  
  amqp-broker-unified:
    image: rabbitmq:3-management
    container_name: amqp-broker-unified
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks:
      - fl-network
  
  # ============================================================================
  # UNIFIED FL SERVER - Handles all 5 protocols simultaneously
  # ============================================================================
  
  fl-server-unified-emotion:
    build:
      context: ..
      dockerfile: Server/Dockerfile
    container_name: fl-server-unified-emotion
    environment:
      - NODE_TYPE=server
      - NUM_CLIENTS=2
      - NUM_ROUNDS=1000
      - MIN_CLIENTS=${MIN_CLIENTS:-2}
      - MAX_CLIENTS=${MAX_CLIENTS:-100}
      - MQTT_BROKER=mqtt-broker-unified
      - AMQP_BROKER=amqp-broker-unified
      - AMQP_HOST=amqp-broker-unified
      - GRPC_HOST=fl-server-unified-emotion
      - GRPC_PORT=50051
      - QUIC_HOST=0.0.0.0
      - QUIC_PORT=4433
      - CONVERGENCE_THRESHOLD=0.001
      - CONVERGENCE_PATIENCE=2
      - MIN_ROUNDS=3
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-ptq}
    volumes:
      - ../Server/Emotion_Recognition:/app/Server/Emotion_Recognition
      - ../experiment_results:/app/results
      - ../certs:/app/certs:ro
      - ../shared_data:/shared_data
    networks:
      - fl-network
    ports:
      - "4433:4433/udp"
      - "50051:50051"
    depends_on:
      - mqtt-broker-unified
      - amqp-broker-unified
    cap_add:
      - NET_ADMIN
    command: python3 Server/Emotion_Recognition/FL_Server_Unified.py
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
  
  # ============================================================================
  # UNIFIED FL CLIENTS - Use RL to select best protocol dynamically
  # ============================================================================
  
  fl-client-unified-emotion-1:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-unified-emotion-1
    environment:
      - NODE_TYPE=client
      - CLIENT_ID=1
      - NUM_CLIENTS=2
      - NUM_ROUNDS=1000
      - USE_RL_SELECTION=true
      - USE_QL_CONVERGENCE=${USE_QL_CONVERGENCE:-false}
      - Q_CONVERGENCE_THRESHOLD=${Q_CONVERGENCE_THRESHOLD:-0.01}
      - Q_CONVERGENCE_PATIENCE=${Q_CONVERGENCE_PATIENCE:-5}
      - DEFAULT_PROTOCOL=mqtt
      - MQTT_BROKER=mqtt-broker-unified
      - AMQP_BROKER=amqp-broker-unified
      - AMQP_HOST=amqp-broker-unified
      - GRPC_HOST=fl-server-unified-emotion
      - GRPC_PORT=50051
      - QUIC_HOST=fl-server-unified-emotion
      - QUIC_PORT=4433
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-ptq}
    volumes:
      - ../Client/Emotion_Recognition:/app/Client/Emotion_Recognition
      - ../shared_data:/shared_data
      - ../experiment_results:/app/results
      - ../certs:/app/certs:ro
    networks:
      - fl-network
    depends_on:
      - fl-server-unified-emotion
      - mqtt-broker-unified
      - amqp-broker-unified
    cap_add:
      - NET_ADMIN
    command: python3 Client/Emotion_Recognition/FL_Client_Unified.py
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
  
  fl-client-unified-emotion-2:
    build:
      context: ..
      dockerfile: Client/Dockerfile
    container_name: fl-client-unified-emotion-2
    environment:
      - NODE_TYPE=client
      - CLIENT_ID=2
      - NUM_CLIENTS=2
      - NUM_ROUNDS=1000
      - USE_RL_SELECTION=true
      - USE_QL_CONVERGENCE=${USE_QL_CONVERGENCE:-false}
      - Q_CONVERGENCE_THRESHOLD=${Q_CONVERGENCE_THRESHOLD:-0.01}
      - Q_CONVERGENCE_PATIENCE=${Q_CONVERGENCE_PATIENCE:-5}
      - DEFAULT_PROTOCOL=mqtt
      - MQTT_BROKER=mqtt-broker-unified
      - AMQP_BROKER=amqp-broker-unified
      - AMQP_HOST=amqp-broker-unified
      - GRPC_HOST=fl-server-unified-emotion
      - GRPC_PORT=50051
      - QUIC_HOST=fl-server-unified-emotion
      - QUIC_PORT=4433
      - USE_QUANTIZATION=${USE_QUANTIZATION:-false}
      - QUANTIZATION_BITS=${QUANTIZATION_BITS:-8}
      - QUANTIZATION_STRATEGY=${QUANTIZATION_STRATEGY:-ptq}
    volumes:
      - ../Client/Emotion_Recognition:/app/Client/Emotion_Recognition
      - ../shared_data:/shared_data
      - ../experiment_results:/app/results
      - ../certs:/app/certs:ro
    networks:
      - fl-network
    depends_on:
      - fl-server-unified-emotion
      - mqtt-broker-unified
      - amqp-broker-unified
    cap_add:
      - NET_ADMIN
    command: python3 Client/Emotion_Recognition/FL_Client_Unified.py
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

networks:
  fl-network:
    driver: bridge
